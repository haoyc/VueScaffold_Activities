const glob = require('glob')
const path = require('path')
const fs = require('fs')
const tips = '// This file is generated by build/bin/build-img.js'

function verifyImgSize(imgPath) {
  let status = fs.statSync(imgPath)
  var imgStatus = path.parse(imgPath)
  var imgName = imgStatus.name
  return status.size > 10000 && imgName.indexOf('_nocache') < 0
}

glob('/src/assets/**/*.{png, jpg, jpeg}', {
  root: path.join(__dirname, '../../')
}, function(err, files) {
  const originPath = path.resolve(__dirname, '../../src/components/optmize')
  const exportList = files.filter(name => verifyImgSize(name))
  const imgPathList = exportList.map(name => `{ imageUrl: require('${path.relative(originPath, name).replace(/\\/g, '/')}') }`)
  const content = `${tips}
const imageList = [
  ${imgPathList.join(',\n  ')}
]

export default imageList`
  fs.writeFileSync(path.join(__dirname, '../../src/components/optimize/imagePath.js'), content)
})